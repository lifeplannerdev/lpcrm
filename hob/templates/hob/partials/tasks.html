<div class="table-container">
    <div style="padding: 1.5rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
        <h3 style="margin: 0; font-size: 1.25rem; font-weight: 600;">All Tasks</h3>
        <button class="btn btn-primary" onclick="openCreateTaskModal()">
            <i class="fas fa-plus"></i>
            Create Task
        </button>
    </div>
    
    <div class="table-scroll-vert">
        <table class="bc-table bc-table-striped">
            <thead>
                <tr>
                    <th>Title</th>
                    <th>Assigned By</th>
                    <th>Assigned To</th>
                    <th>Priority</th>
                    <th>Status</th>
                    <th>Deadline</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for task in tasks %}
                <tr>
                    <td>
                        <strong>{{ task.title }}</strong>
                        {% if task.is_overdue %}
                            <span style="background: rgba(239, 68, 68, 0.2); color: #fca5a5; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.7rem; font-weight: 600; margin-left: 0.5rem;">
                                OVERDUE
                            </span>
                        {% endif %}
                        <br>
                        <small style="color: var(--text-secondary);">{{ task.description|truncatewords:10 }}</small>
                    </td>
                    <td>{{ task.assigned_by.get_full_name }}</td>
                    <td>
                        {{ task.assigned_to.get_full_name }}
                        <br>
                        <small style="color: var(--text-secondary);">{{ task.assigned_to.get_role_display }}</small>
                    </td>
                    <td>
                        <span style="padding: 0.25rem 0.75rem; border-radius: 50px; font-size: 0.8rem; font-weight: 600; 
                            {% if task.priority == 'LOW' %}background: rgba(16, 185, 129, 0.2); color: #86efac;
                            {% elif task.priority == 'MEDIUM' %}background: rgba(245, 158, 11, 0.2); color: #fcd34d;
                            {% elif task.priority == 'HIGH' %}background: rgba(239, 68, 68, 0.2); color: #fca5a5;
                            {% else %}background: rgba(239, 68, 68, 0.4); color: #fca5a5; border: 1px solid rgba(239, 68, 68, 0.6);
                            {% endif %}">
                            {{ task.get_priority_display }}
                        </span>
                    </td>
                    <td>
                        <span style="padding: 0.25rem 0.75rem; border-radius: 50px; font-size: 0.8rem; font-weight: 600; 
                            {% if task.status == 'PENDING' %}background: rgba(245, 158, 11, 0.2); color: #fcd34d;
                            {% elif task.status == 'IN_PROGRESS' %}background: rgba(59, 130, 246, 0.2); color: #93c5fd;
                            {% elif task.status == 'COMPLETED' %}background: rgba(16, 185, 129, 0.2); color: #86efac;
                            {% else %}background: rgba(107, 114, 128, 0.2); color: #9ca3af;
                            {% endif %}">
                            {{ task.get_status_display }}
                        </span>
                    </td>
                    <td>
                        {% if task.is_overdue %}
                            <span style="color: #ef4444; font-weight: 600;">{{ task.deadline|date:"M d, Y H:i" }}</span>
                        {% else %}
                            {{ task.deadline|date:"M d, Y H:i" }}
                        {% endif %}
                    </td>
                    <td>
                        <div style="display: flex; gap: 0.5rem;">
                            <button style="background: transparent; border: none; color: var(--text-secondary); cursor: pointer; padding: 0.5rem; border-radius: 6px; transition: all 0.2s ease;" 
                                    onmouseover="this.style.background='var(--bg-secondary)'; this.style.color='var(--text-primary)'"
                                    onmouseout="this.style.background='transparent'; this.style.color='var(--text-secondary)'"
                                    onclick="deleteTask({{ task.id }})" 
                                    title="Delete Task">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7" style="text-align: center; color: var(--text-secondary); padding: 2rem;">
                        No tasks found
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Create Task Modal -->
<div id="createTaskModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 10000; align-items: center; justify-content: center; backdrop-filter: blur(10px);">
    <div class="modal-content" style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 16px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto;">
        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; padding: 1.5rem; border-bottom: 1px solid var(--border-color);">
            <h2 class="modal-title" style="font-size: 1.5rem; font-weight: 600; margin: 0;">Create New Task</h2>
            <button class="modal-close" onclick="closeCreateTaskModal()" style="background: transparent; border: none; color: var(--text-secondary); font-size: 1.5rem; cursor: pointer; padding: 0.5rem; border-radius: 8px;">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="createTaskForm" onsubmit="createTask(event)">
            <div class="modal-body" style="padding: 1.5rem;">
                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label class="form-label" for="taskTitle" style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-primary);">Title *</label>
                    <input type="text" id="taskTitle" class="form-control" required placeholder="Enter task title" style="width: 100%; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; padding: 0.75rem; color: var(--text-primary); font-size: 1rem; transition: border 0.2s ease;">
                </div>
                
                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label class="form-label" for="taskDescription" style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-primary);">Description *</label>
                    <textarea id="taskDescription" class="form-control form-textarea" required placeholder="Enter task description" style="width: 100%; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; padding: 0.75rem; color: var(--text-primary); font-size: 1rem; resize: vertical; min-height: 100px;"></textarea>
                </div>
                
                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label class="form-label" for="taskAssignedTo" style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-primary);">Assign To *</label>
                    <select id="taskAssignedTo" class="form-control" required style="width: 100%; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; padding: 0.75rem; color: var(--text-primary); font-size: 1rem;">
                        <option value="">Select team member</option>
                        {% for member in staff_members %}
                            <option value="{{ member.id }}">
                                {{ member.get_full_name }} - {{ member.get_role_display }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label class="form-label" for="taskPriority" style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-primary);">Priority</label>
                    <select id="taskPriority" class="form-control" style="width: 100%; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; padding: 0.75rem; color: var(--text-primary); font-size: 1rem;">
                        <option value="LOW">Low</option>
                        <option value="MEDIUM" selected>Medium</option>
                        <option value="HIGH">High</option>
                        <option value="URGENT">Urgent</option>
                    </select>
                </div>
                
                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label class="form-label" for="taskDeadline" style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-primary);">Deadline *</label>
                    <input type="datetime-local" id="taskDeadline" class="form-control" required style="width: 100%; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; padding: 0.75rem; color: var(--text-primary); font-size: 1rem;">
                </div>
            </div>
            <div class="modal-footer" style="display: flex; justify-content: flex-end; gap: 1rem; padding: 1.5rem; border-top: 1px solid var(--border-color);">
                <button type="button" class="btn btn-secondary" onclick="closeCreateTaskModal()" style="padding: 0.75rem 1.5rem; border-radius: 8px; font-size: 0.9rem; font-weight: 500; border: none; cursor: pointer; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color);">Cancel</button>
                <button type="submit" class="btn btn-primary" style="padding: 0.75rem 1.5rem; border-radius: 8px; font-size: 0.9rem; font-weight: 500; border: none; cursor: pointer; background: var(--accent); color: var(--bg-primary);">Create Task</button>
            </div>
        </form>
    </div>
</div>

<script>
function openCreateTaskModal() {
    document.getElementById('createTaskModal').style.display = 'flex';
    // Set min datetime to current time
    const now = new Date();
    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
    document.getElementById('taskDeadline').min = now.toISOString().slice(0, 16);
}

function closeCreateTaskModal() {
    document.getElementById('createTaskModal').style.display = 'none';
    document.getElementById('createTaskForm').reset();
}

function createTask(event) {
    event.preventDefault();
    
    const formData = {
        title: document.getElementById('taskTitle').value,
        description: document.getElementById('taskDescription').value,
        assigned_to: document.getElementById('taskAssignedTo').value,
        priority: document.getElementById('taskPriority').value,
        deadline: document.getElementById('taskDeadline').value
    };
    
    axios.post('{% url "hob:create_task" %}', formData)
        .then(response => {
            if (response.data.status === 'success') {
                showToast('Task created successfully!', 'success');
                closeCreateTaskModal();
                // Reload the tasks tab
                loadTabContent('tasks');
            }
        })
        .catch(error => {
            console.error('Error creating task:', error);
            showToast('Error creating task. Please try again.', 'error');
        });
}

function deleteTask(taskId) {
    if (confirm('Are you sure you want to delete this task? This action cannot be undone.')) {
        axios.post(`/hob/tasks/${taskId}/delete/`)
            .then(response => {
                if (response.data.status === 'success') {
                    showToast('Task deleted successfully!', 'success');
                    // Reload the tasks tab
                    loadTabContent('tasks');
                }
            })
            .catch(error => {
                console.error('Error deleting task:', error);
                showToast('Error deleting task. Please try again.', 'error');
            });
    }
}

function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.textContent = message;
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 1rem 1.5rem;
        border-radius: 12px;
        color: white;
        font-weight: 500;
        z-index: 10001;
        animation: slideIn 0.3s ease;
        background: ${type === 'success' ? '#10b981' : '#ef4444'};
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease forwards';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// Add CSS animations
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
`;
document.head.appendChild(style);

// Close modal when clicking outside
document.getElementById('createTaskModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeCreateTaskModal();
    }
});

// Close modal with escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeCreateTaskModal();
    }
});
</script>